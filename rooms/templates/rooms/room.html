{% extends 'base.html' %}

{% block content %}

    <h1>{{ room.name }}</h1>
    <h2>user</h2>

    <ul>
        {% if room.user1 is not None %}
        <li>{{ room.user1.username }}</li>
        {% endif %}
        {% if room.user2 is not None%}
        <li>{{ room.user2.username }}</li>
        {% endif %}
        {% if room.user3 is not None%}
        <li>{{ room.user3.username  }}</li>
        {% endif %}
        {% if room.user4 is not None%}
        <li>{{ room.user4.username  }}</li>
        {% endif %}
    </ul>

    <h2>Chat</h2>
    <textarea id="chat-log" cols="100" rows="20"></textarea><br/>
    <input id="chat-message-input" type="text" size="100"/><br/>
    <input id="chat-message-submit" type="button" value="Send"/><br/>

    <p>スクリプトを選択してください</p>
        <label for="script_name">スクリプト名</label>
        <select id = "script_name">
            {% for script in my_scripts %}
                <option value="{{ script.name }}">{{ script.name }}</option>
            {% endfor %}
        </select>
        <br>
        <input id = "go-to-game" type="button" value="ゲームスタート">

    <button type="button" class="btn btn-primary btn-lg" onclick="location.href='{% url 'rooms:exit' room.pk %}'">Exit room</button>


{% endblock %}


{% block script %}
    <script>
        var roomPk = {{ room.pk }};


        var chatSocket = new WebSocket(
            'ws://' + window.location.host +
            '/ws/rooms/' + roomPk + '/');

        chatSocket.onmessage = function(e) {//when getting a message
            var data = JSON.parse(e.data);
            var message = data['message'];
            var username = data['username'];
            document.querySelector('#chat-log').value += (username+":\t"+message + '\n');
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };


        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };




        document.querySelector('#chat-message-submit').onclick = function(e) {
            var messageInputDom = document.querySelector('#chat-message-input');
            var message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'username':"{{ user.username }}",
                'message': message
            }));

            messageInputDom.value = '';
        };
    </script>
{% endblock %}




